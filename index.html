<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Forbedret Tower Defence</title>
<style>
body {
    background: #1e1e1e;
    color: #eee;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 10px;
}
#gameContainer {
    margin: 10px auto;
    position: relative;
    width: 640px;
}
canvas {
    background: #3b6b2a;
    border: 3px solid #555;
    display: block;
    margin: 0 auto;
    cursor: crosshair;
}
#ui span { margin: 0 10px; }

.towerBtn {
    padding: 8px 12px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    color: white;
    font-weight: bold;
}
.normal { background:#4a90e2 }
.fast { background:#50e3c2 }
.heavy { background:#e94e77 }

/* üîπ OPPGRADERINGSMENY */
#upgradeMenu {
    position: absolute;
    background: #222;
    border: 2px solid #555;
    padding: 10px;
    display: none;
    z-index: 10;
}
#upgradeMenu button {
    margin: 4px;
    width: 100%;
}
</style>
</head>

<body>
<h1>Forbedret Tower Defence</h1>

<div id="gameContainer">
    <canvas id="game" width="640" height="480"></canvas>

    <!-- üîπ Oppgraderingsmeny -->
    <div id="upgradeMenu">
        <div id="towerStats"></div>
        <button onclick="upgradeDamage()">‚¨Ü Skade (20)</button>
        <button onclick="upgradeSpeed()">‚ö° Hastighet (20)</button>
        <button onclick="sellTower()">üóëÔ∏è Selg t√•rn</button>
    </div>
</div>

<div id="ui">
<span>Liv: <b id="lives">20</b></span>
<span>Penger: <b id="money">150</b></span>
<span>B√∏lge: <b id="wave">1</b></span>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const TILE = 40;

let towers = [];
let enemies = [];
let bullets = [];
let lives = 20;
let money = 150;
let wave = 1;

let selectedTower = null;
const upgradeMenu = document.getElementById("upgradeMenu");
const statsEl = document.getElementById("towerStats");

function gridToPixel(g){
    return {x:g.x*TILE+TILE/2, y:g.y*TILE+TILE/2}
}

/* ---------------- T√ÖRN ---------------- */
class Tower {
    constructor(x,y){
        this.x=x; this.y=y;
        this.damage=10;
        this.fireRate=35;
        this.range=120;
        this.cooldown=0;
    }
    update(){
        this.cooldown--;
        if(this.cooldown>0) return;

        let target=enemies.find(e=>Math.hypot(e.x-this.x,e.y-this.y)<this.range);
        if(target){
            bullets.push(new Bullet(this.x,this.y,target,this.damage));
            this.cooldown=this.fireRate;
        }
    }
    draw(){
        ctx.fillStyle="#4a90e2";
        ctx.beginPath();
        ctx.arc(this.x,this.y,14,0,Math.PI*2);
        ctx.fill();
    }
}

/* ---------------- KULER ---------------- */
class Bullet{
    constructor(x,y,target,damage){
        this.x=x; this.y=y;
        this.target=target;
        this.damage=damage;
        this.dead=false;
    }
    update(){
        if(!this.target){this.dead=true;return;}
        let dx=this.target.x-this.x;
        let dy=this.target.y-this.y;
        let d=Math.hypot(dx,dy);
        if(d<4){
            this.target.hp-=this.damage;
            if(this.target.hp<=0) money+=5;
            this.dead=true;
        } else {
            this.x+=dx/d*4;
            this.y+=dy/d*4;
        }
    }
    draw(){
        ctx.fillStyle="#ff0";
        ctx.beginPath();
        ctx.arc(this.x,this.y,4,0,Math.PI*2);
        ctx.fill();
    }
}

/* ---------------- FIENDER ---------------- */
class Enemy{
    constructor(){
        this.x=0; this.y=240;
        this.hp=40;
    }
    update(){ this.x+=0.5 }
    draw(){
        ctx.fillStyle="#f44";
        ctx.beginPath();
        ctx.arc(this.x,this.y,12,0,Math.PI*2);
        ctx.fill();
    }
}

/* ---------------- KLIKK ---------------- */
canvas.addEventListener("click", e=>{
    const rect=canvas.getBoundingClientRect();
    const x=e.clientX-rect.left;
    const y=e.clientY-rect.top;

    selectedTower=null;
    upgradeMenu.style.display="none";

    for(const t of towers){
        if(Math.hypot(t.x-x,t.y-y)<15){
            selectedTower=t;
            showUpgradeMenu(x,y,t);
            return;
        }
    }

    if(money>=50){
        towers.push(new Tower(x,y));
        money-=50;
    }
});

/* ---------------- OPPGRADERING ---------------- */
function showUpgradeMenu(x,y,t){
    upgradeMenu.style.left=x+"px";
    upgradeMenu.style.top=y+"px";
    upgradeMenu.style.display="block";
    updateStats();
}

function updateStats(){
    statsEl.innerHTML=`
    Skade: ${selectedTower.damage}<br>
    Fire rate: ${selectedTower.fireRate}
    `;
}

function upgradeDamage(){
    if(money>=20){
        selectedTower.damage+=5;
        money-=20;
        updateStats();
    }
}

function upgradeSpeed(){
    if(money>=20 && selectedTower.fireRate>10){
        selectedTower.fireRate-=5;
        money-=20;
        updateStats();
    }
}

function sellTower(){
    money+=30;
    towers=towers.filter(t=>t!==selectedTower);
    upgradeMenu.style.display="none";
}

/* ---------------- LOOP ---------------- */
function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(Math.random()<0.01) enemies.push(new Enemy());

    enemies.forEach(e=>e.update());
    towers.forEach(t=>t.update());
    bullets.forEach(b=>b.update());

    enemies=enemies.filter(e=>e.hp>0);
    bullets=bullets.filter(b=>!b.dead);

    enemies.forEach(e=>e.draw());
    towers.forEach(t=>t.draw());
    bullets.forEach(b=>b.draw());

    document.getElementById("money").textContent=money;
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
